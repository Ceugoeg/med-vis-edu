# Member A 功能汇总（V2）

> 版本基准：`/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe` 当前代码
> 本文覆盖 `v1.5.md` / `introC.md` 中与现代码冲突的描述，以代码实际行为为准。

## 1. A 侧数据发布总线（`window.handData`）

A 侧已实现并持续输出：
- `state`: `OPEN | FIST | PINCH | NONE`
- `landmarks`: 21 点归一化坐标（`x,y,z`）
- `confidence`: 0-1

实现文件：
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/drivers/mediapipe-sense/mediapipe_hand_publisher.js`
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/drivers/mediapipe-sense/runtime_loader.js`

## 2. 主逻辑链（以当前代码为准）

### 2.1 握拳聚合态（FIST -> WHOLE）

手势操作：
- 当检测为 `FIST` 且处于 `SCATTERED`：触发聚合（`explodeFactor -> 0`），回到 `WHOLE`。
- 当检测为 `FIST` 且处于 `FOCUSED`：先退出特写，回到 `SCATTERED`。
- 当检测为 `FIST` 且处于 `WHOLE`：进入整体拖拽旋转。

降级鼠标：
- 仅在 `MOCK_MODE=false` 时启用（当前代码固定 `MOCK_MODE=true`，默认不走鼠标降级）。

数学/状态约束：
- FIST 上升沿防抖锁（`fistActionFired`）防重复触发。
- FIST 判定使用多条件：四指卷曲计数 + Y 向收拢计数 + 拇指卷曲阈值 + 卷曲辅助计数。

### 2.2 张开散开态（OPEN -> SCATTERED）

手势操作：
- 当检测为 `OPEN` 且处于 `WHOLE`：触发散开（`explodeFactor -> 1`），进入 `SCATTERED`。
- 在 `SCATTERED` 下，OPEN/NONE 会触发边缘拨动（edge panning）用于全局缓慢旋转。

降级鼠标：
- `MOCK_MODE=false` 时，滚轮可从 `WHOLE` 触发散开。

数学/状态约束：
- OPEN 判定使用多条件：四指伸展计数 + Y 向展开计数 + 拇指伸展阈值 + 伸展辅助计数。
- 离开 FIST/PINCH 后，OPEN 需连续确认帧（`openConfirmFramesAfterAction`）避免误触发。
- 边缘拨动死区半径：`deadzoneRadius = 0.35`。

### 2.3 旋转功能

手势操作：
- `WHOLE + FIST`：按食指坐标增量驱动全局旋转。
- `FOCUSED + PINCH`：按食指坐标增量驱动局部旋转。
- 松手后保留动量，阻尼衰减。

降级鼠标：
- `MOCK_MODE=false` 时：左键拖拽旋转；点击可射线选中。

数学/状态约束：
- 旋转速度映射：`delta * PI * 1.5`。
- 阻尼通过 `MathPhysicsUtil.applyDamping` 实现。
- 四元数更新：`premultiply` + `slerp`（平滑到目标姿态）。

### 2.4 捏合功能（PINCH）

手势操作：
- `SCATTERED + PINCH`：触发一次射线命中（上升沿触发），命中后进入 `FOCUSED`。
- `FOCUSED + PINCH`：继续局部旋转。

降级鼠标：
- `MOCK_MODE=false` 时，点击触发 `onRaycast`。

数学/状态约束：
- PINCH 采用动态阈值：`pinchRatio = dist(4,8) / dist(0,5)`，阈值 `0.34`。
- 仅在基线满足时允许 PINCH（稳定态为 PINCH/OPEN 或 `openYCount >= 2`）。
- PINCH 上升沿锁（`pinchFired`）防止长按连续触发。

## 3. A 侧稳定性增强（已实现）

- 一阶滞后滤波：`alpha` 基础值 `0.2`。
- 自适应滤波：`alpha` 随手速在 `[0.16, 0.5]` 内动态变化。
- 滑动窗口投票：`stateVoteWindow = 5`。
- 状态保持：`stateHoldFrames = 1`。
- 过渡死区：离开关键态后 OPEN 需确认帧。
- 启动失败回退：加载 mock 驱动并维持 `handData` 默认结构。

## 4. 主逻辑链外已实现功能（简要说明）

- 手势引导层：首屏有手势操作引导弹层（PINCH/OPEN/FIST/NONE），支持按钮或 `Esc` 关闭。
- 语音输入链路（STT）：支持“捏合上升沿触发录音、OPEN/NONE松手停止、取消区松手取消”的手势语音交互。
- 意图驱动链路（LLM）：文本/语音可先经意图解析，再自动触发“散开-命中-特写”聚焦流程。
- UI 状态视觉反馈：`hit-active` / `scatter-active` 两套视觉态会联动侧栏与提示，反馈当前交互上下文。
- 交互状态机上升沿防抖锁：`fistActionFired` / `pinchFired` 防止同一手势在连续帧重复触发关键动作。
- 磁吸选中辅助：`SCATTERED` 态下准星可吸附最近可见部件中心，降低捏合选中难度。

## 5. 当前代码下的边界与注意事项（覆盖旧文档）

- 当前未实现“基于 Frustum 的散开上限硬约束”（不是 A 发布层逻辑，属于 C 侧渲染约束）。
- 当前并非“OPEN 后完全禁止旋转”：在 `SCATTERED` 下存在 edge panning。
- `MOCK_MODE` 当前固定为 `true`，因此鼠标降级逻辑默认不生效（除非改主程序常量）。

## 6. 关键参数（当前默认）

- 手势输入：`minDetectionConfidence=0.6`，`minTrackingConfidence=0.6`
- 滤波：`smoothingAlpha=0.2`，`adaptiveSmoothing=true`
- PINCH：`dynamicPinch=true`，`pinchRatioThreshold=0.34`
- OPEN/FIST：采用 enter/exit 双阈值（hysteresis）
- 稳定器：`stateVoteWindow=5`，`openConfirmFramesAfterAction=2`

---

## 7. V2.0 增量更新汇总（追加）

> 以下内容为在 V2 基础上的新增/修订，均以当前代码为准。

### 7.1 A 侧手势判定与稳态（Publisher）更新

- `PINCH` 误判抑制：在拇食指捏合成立之外，新增“中指/无名指/小拇指张开门控”。
  - 非 `PINCH` 稳态时要求更严格（3/3）。
  - 已处于 `PINCH` 稳态时允许 2/3，减少抖动掉态。
- `FIST` 容错放宽：由“近乎四指全满足”调整为“食指+中指为核心，且无名指/小拇指至少一根卷曲”。
- 新增强制 `FIST` 机制：握拳候选持续超过阈值时，若仍被判 `NONE` 则强制切到 `FIST`。
  - 当前阈值：`forceFistAfterMs = 300`（由此前更长时长下调）。
  - 候选判定改为方向无关的距离压缩逻辑，弱化对手掌正对屏幕的依赖。
- 新增 `FIST` 锁存：进入 `FIST` 后，`NONE` 不再生效；仅 `OPEN` 或 `PINCH` 可切出。
  - 同时覆盖“无手关键点”分支，避免 `FIST -> NONE` 回落。

对应文件：
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/drivers/mediapipe-sense/mediapipe_hand_publisher.js`

### 7.2 WHOLE 模式旋转链路更新（不改手势定义）

- 新增 `WHOLE + FIST` 持续 1 秒进入 `PINCH-like` 子模式（不改 `appMode`，仅改旋转输入消费）。
  - 子模式下旋转灵敏度提升（`1.9`）。
  - UI 输入显示可映射为 `PINCH`（`effectiveGesture`），便于识别当前控制态。
- 在 `WHOLE` 旋转新增“输入稳定层”（解决边界回位反向误判）：
  - 边界保护区：`wholeEdgeGuardRatio = 0.05`
  - 重入解锁：`wholeReentryFramesRequired = 3`
  - 跳变抑制：`wholeDeltaClamp = 0.03`
  - 冷却缓冲：重入/跳变后短帧抑制，避免回位动作触发反向旋转

对应文件：
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/controllers/interaction_hsm.js`
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/app.js`

### 7.3 视觉与引导更新

- 散开范围收缩：`explosionRadius` 由 `12.0` 调整为 `8.0`，提升视距内可见零件密度。
- 引导弹层文案重写：
  - `PINCH`：利用两根手指选中部位、旋转、或激活麦克风
  - `OPEN`：张开手掌从期望视角散开模型
  - `FIST`：增加进入条件提示 + 用途说明双行
  - `NONE`：保持不变

对应文件：
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/app.js`
- `/Users/ruoqingxu/Desktop/challenge cup /med-vis-edu-feat-integrate-mediapipe/index.html`

### 7.4 当前行为说明（与联调体验相关）

- `SCATTERED` 下 `PINCH` 仍为“上升沿一次射线”模式：未命中需先松手再捏合重试。
- `WHOLE` 下旋转主路径已具备“边界回位不反转”保护，但参数仍可按现场设备继续微调。

---

最后更新：2026-02-27
