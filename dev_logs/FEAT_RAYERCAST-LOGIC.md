# 模块开发日志：Raycaster 逻辑与状态机重构 (FEAT_RAYERCAST-LOGIC)
> 2026.2.22 16:59

## 1. 核心架构重构：事件驱动向状态轮询的迁移
为了适应 MediaPipe 摄像头传回的连续数据流（特别是处理低至 20FPS 的采样率），系统废弃了基于 `mouseup/mousemove` 的离散事件监听方案，全面拥抱“状态驱动”。
构建了以 `requestAnimationFrame` (60Hz) 为核心的轮询机制。通过解耦空间坐标（A 负责一阶滞后滤波）和时间轴（C 负责补间追赶插值），完美抹平了低频硬件采样带来的 3D 渲染顿挫感。同时，引入 `mock_hands.js` 构建了测试台 (Testbed)，支持无缝模拟摄像头输入。

## 2. 交互范式修正：Delta 映射与防抖
修复了早期设计中“绝对坐标映射”带来的模型视角跳变（Snap/Jump）缺陷。
- **悬停瞄准**：在 `NONE` 或 `OPEN` 状态下，将指尖坐标映射为屏幕准星，实现“激光笔式”的精准瞄准，模型锁定不转。
- **抓取旋转**：在触发 `PINCH`（捏合）的下降沿瞬间发射射线（Raycaster）获取模型，随后采用相对位移（Delta X/Y）控制模型的 `Rotation` 矩阵，解决了“松手再捏合会闪现”的灾难级体验。

## 3. 视觉与纠错闭环
移除了不合理的全局“脱靶”警报。现在的交互逻辑仅在合法状态下触发命中效果（利用 CSS 内阴影实现全屏金色锁定/红色报警发光），同时在空旷区域捏合仅做静默处理或纯视角旋转，极大提升了宽容度和沉浸感。

## 4. 层次状态机 (HSM) 与包围盒计算
这是本次迭代最核心的底层数学突破。将扁平的交互升级为 `WHOLE`（整体检视）、`SCATTERED`（散开抓取）、`FOCUSED`（单体聚焦特写）三层状态。
- **矩阵隔离**：引入 `pivotGroup` 隔离了旋转和平移矩阵。
- **包围盒计算 (AABB)**：针对零散零件旋转时“无法看到背面”的物理质心偏移问题，利用 `THREE.Box3` 动态计算散开零件的真实“几何中心”。
- **自适应特写**：在进入 `FOCUSED` 状态时，不仅将该零件的几何中心对齐世界原点以保证完美的自转，还根据 Box3 计算出的体积动态调整相机的 Z 轴焦距，实现大型结构拉远、微小结构推近的完美特写。